<!DOCTYPE html>
<html>

<head>
    <title>Mini Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js"></script>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000000;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            flex-direction: column;
        }

        #blueSquare {
            width: 45vw;
            height: 45vw;
            background-color: #c70000;
            position: absolute;
            top: 62%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(0deg);
            z-index: 1;
            animation: spin 5s linear infinite;
        }

        #greenSquare {
            width: 30vw;
            height: 30vw;
            background-color: #00ff0000;
            background-image: url('https://raw.githubusercontent.com/Abinaell/mini_jogos/main/Logo%20(1).png');
            background-size: cover;
            position: absolute;
            top: 62%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            cursor: pointer;
        }

        @keyframes spin {
            from {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        #userName {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 4vw;
            color: #ffffff;
            z-index: 1;
            font-weight: bold;
        }

        #tokens {
            position: absolute;
            top: 38%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ffffff;
            display: flex;
            align-items: center;
            z-index: 1;
        }

        #tokens {
            font-size: 8vw;
            margin-bottom: 0;
            font-weight: bold;
        }

        #tokens img {
            width: 9vw;
            height: auto;
            margin-right: 10px;
        }

        #tokensPerMinuteWrapper {
            position: absolute;
            top: 10px;
            right: 10px;
            text-align: center;
            color: #ffffff;
            z-index: 1;
        }

        #minerandoText {
            font-size: 2.2vw;
            color: #9b1c1c;
        }

        #tokensPerMinute {
            font-size: 3vw;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 5px;
            font-weight: bold;
        }

        #tokensPerMinute img {
            width: 4.5vw;
            height: auto;
            margin-right: 5px;
        }

        #modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgb(0, 0, 0);
            justify-content: center;
            align-items: center;
            z-index: 3;
            flex-direction: column;
            color: white;
            font-size: 2vw;
            font-weight: bold;
        }

        #closeModal {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 10vw;
            cursor: pointer;
            font-weight: bold;
        }

        #purchaseModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgb(0, 0, 0);
            justify-content: center;
            align-items: center;
            z-index: 4;
            flex-direction: column;
            color: white;
            font-size: 2vw;
            font-weight: bold;
        }

        #closePurchaseModal {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 10vw;
            cursor: pointer;
            font-weight: bold;
        }

        #confirmPurchaseModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgb(0, 0, 0);
            justify-content: center;
            align-items: center;
            z-index: 5;
            flex-direction: column;
            color: white;
            font-size: 2vw;
            font-weight: bold;
        }

        #closeConfirmPurchaseModal {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 10vw;
            cursor: pointer;
            font-weight: bold;
        }

        #buyTokensPerMinute {
            margin-top: 20px;
            text-align: center;
        }

        #buyTokensPerMinute .buttonContainer {
            display: flex;
            overflow-x: auto;
            /* Allow horizontal scrolling */
            padding: 10px 0;
        }

        .tokenButton {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #4CAF50;
            /* Default color for Buy button */
            padding: 10px;
            margin: 10px;
            border-radius: 10px;
            /* Slightly rounded corners */
            border: none;
            color: #fff;
            font-weight: bold;
            width: 120px;
            /* Set a fixed width */
            cursor: pointer;
            position: relative;
        }

        .tokenButton img {
            width: 60%;
            /* Set a width for the button image */
            height: auto;
            position: absolute;
            top: -20px;
            /* Position the image above the button */
        }

        #purchaseContent {
            text-align: center;
        }

        #purchaseContent img {
            width: 40vw;
            height: auto;
            margin-bottom: 10px;
        }

        #confirmPurchase {
            background-color: #008CBA;
            /* Default color for Confirm button */
            padding: 10px 20px;
            font-size: 2vw;
            cursor: pointer;
            margin-top: 20px;
            border-radius: 10px;
            /* Slightly rounded corners */
            border: none;
            color: #fff;
            font-weight: bold;
        }

        #levelBar {
            position: absolute;
            top: 5%;
            left: 50%;
            width: 50%;
            height: 7px;
            background-color: #333;
            border-radius: 2px;
            transform: translate(-50%, -50%);
            z-index: 1;
        }

        #levelProgress {
            height: 100%;
            background-color: #ffffff;
            border-radius: 2px;
            width: 0;
        }

        #levelText {
            position: absolute;
            top: 2%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ffffff;
            font-size: 3vw;
            z-index: 2;
            font-weight: bold;
        }

        strong {
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div id="gameCanvas">
        <div id="userName"><strong></strong></div>
        <div id="tokens">
            <img src="https://raw.githubusercontent.com/Abinaell/mini_jogos/main/logoo.png" alt="Token Logo">
            <span id="tokensText">0</span>
        </div>
        <div id="tokensPerMinuteWrapper">
            <div id="minerandoText">Minerando por hora</div>
            <div id="tokensPerMinute">
                <img src="https://raw.githubusercontent.com/Abinaell/mini_jogos/main/logoo.png" alt="Token Logo">
                <span id="tokensPerMinuteText">0</span>
            </div>
        </div>
        <div id="levelBar">
            <div id="levelProgress"></div>
        </div>
        <div id="levelText">Nível 1</div>
        <div id="blueSquare"></div>
        <div id="greenSquare"></div>
        <div id="modal">
            <div id="closeModal">✖</div>
            <div id="buyTokensPerMinute">
                <div class="buttonContainer">
                    <button class="tokenButton" id="buyTokenPerMinute1" data-price="100" data-value="1">Comprar<br>1 Token/hora</button>
                    <button class="tokenButton" id="buyTokenPerMinute2" data-price="500" data-value="5">Comprar<br>5 Tokens/hora</button>
                    <button class="tokenButton" id="buyTokenPerMinute3" data-price="2500" data-value="10">Comprar<br>10 Tokens/hora</button>
                    <button class="tokenButton" id="buyTokenPerMinute4" data-price="5000" data-value="20">Comprar<br>20 Tokens/hora</button>
                </div>
            </div>
        </div>
        <div id="confirmPurchaseModal">
            <div id="closeConfirmPurchaseModal">✖</div>
            <div id="purchaseContent">
                <img src="https://raw.githubusercontent.com/Abinaell/mini_jogos/main/logoo.png" alt="Token Logo">
                <div>
                    <strong>Você está prestes a comprar</strong>
                </div>
                <div id="confirmTokensValue">0</div>
                <div>
                    <strong>por</strong>
                </div>
                <div id="confirmTokensPrice">0</div>
                <button id="confirmPurchaseButton">Confirmar Compra</button>
            </div>
        </div>
    </div>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAaBhGJRNvRCR10W4Gq3EcCl2TsL3WQMAM",
            authDomain: "sem-nome-67842.firebaseapp.com",
            projectId: "sem-nome-67842",
            storageBucket: "sem-nome-67842.appspot.com",
            messagingSenderId: "89506692234",
            appId: "1:89506692234:web:f5c71e3b97c401d99e4173",
            measurementId: "G-Y3811R0ZLX"
        };

        // Inicializando o Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let tokens = 0;
        let tokensPerHour = 0;
        let pricePerTokenHour = 100;
        let tokensPerHourValue = 1;
        let boughtTokenPerHour = false;
        let purchaseConfirmationPending = false;
        let level = 1;
        const tokensPerLevel = 25000;
        let selectedButtonPrice = 0;
        let selectedButtonValue = 0;

        function formatNumber(number) {
            return number.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        const queryParams = new URLSearchParams(window.location.search);
        const userId = queryParams.get('user_id');
        const userName = queryParams.get('user_name');

        if (!userId || !userName) {
            console.error('user_id ou user_name não foram definidos na URL.');
        }

        async function registerOrLogin() {
            const userDoc = db.collection('users').doc(userId);
            const doc = await userDoc.get();

            if (doc.exists) {
                const data = doc.data();
                tokens = data.tokens || 0;
                tokensPerHour = data.tokens_per_hour || 0;
                pricePerTokenHour = data.price_per_token_hour || 100;
                tokensPerHourValue = data.tokens_per_hour_value || 1;
                boughtTokenPerHour = data.bought_token_per_hour || false;
                level = data.level || 1;
            } else {
                // Se o usuário não existir, crie um novo
                await userDoc.set({
                    user_name: userName,
                    tokens: 0,
                    tokens_per_hour: 0,
                    price_per_token_hour: 100,
                    tokens_per_hour_value: 1,
                    bought_token_per_hour: false,
                    level: 1
                });
            }
        }

        async function updateTokens() {
            const userDoc = db.collection('users').doc(userId);
            await userDoc.update({
                tokens,
                tokens_per_hour: tokensPerHour,
                price_per_token_hour: pricePerTokenHour,
                tokens_per_hour_value: tokensPerHourValue,
                bought_token_per_hour: boughtTokenPerHour,
                level
            });
        }

        async function buyOrUpgradeTokensPerHour(button) {
            selectedButtonPrice = parseInt(button.getAttribute('data-price'));
            selectedButtonValue = parseInt(button.getAttribute('data-value'));

            if (tokens >= selectedButtonPrice) {
                document.getElementById('modal').style.display = 'none';
                document.getElementById('confirmPurchaseModal').style.display = 'flex';
                document.getElementById('confirmTokensValue').innerText = selectedButtonValue;
                document.getElementById('confirmTokensPrice').innerText = selectedButtonPrice;
                purchaseConfirmationPending = true;
            } else {
                alert('Você não tem tokens suficientes para esta compra.');
            }
        }

        async function confirmPurchase() {
            if (purchaseConfirmationPending) {
                tokens -= selectedButtonPrice;
                tokensPerHour += selectedButtonValue;

                if (!boughtTokenPerHour) {
                    boughtTokenPerHour = true;
                    document.getElementById('buyTokenPerMinute1').innerText = 'Upar Token por Hora';
                } else {
                    pricePerTokenHour = Math.floor(pricePerTokenHour * 1.32);
                    tokensPerHourValue = Math.floor(tokensPerHourValue * 1.28);
                }

                const newLevel = Math.floor(tokensPerHour / tokensPerLevel) + 1;
                if (newLevel !== level) {
                    level = newLevel;
                    document.getElementById('levelText').innerText = `Nível ${level}`;
                }

                await updateTokens();
                document.getElementById('tokensText').innerText = formatNumber(tokens);
                document.getElementById('tokensPerMinuteText').innerText = formatNumber(tokensPerHour);
                document.getElementById('priceText').innerText = formatNumber(pricePerTokenHour);
                document.getElementById('tokensPerMinuteValueText').innerText = formatNumber(tokensPerHourValue);

                document.getElementById('confirmPurchaseModal').style.display = 'none';
                purchaseConfirmationPending = false;

                if (navigator.vibrate) {
                    navigator.vibrate(200);
                }
            }
        }

        function updateLevelBar() {
            const progress = Math.min(100, (tokensPerHour % tokensPerLevel) / tokensPerLevel * 100);
            document.getElementById('levelProgress').style.width = `${progress}%`;
        }

        function generateTokensGradually() {
            setInterval(() => {
                if (tokensPerHour > 0) {
                    tokens += Math.floor(tokensPerHour / 24);
                    updateLevelBar();
                    updateTokens();
                    document.getElementById('tokensText').innerText = formatNumber(tokens);
                }
            }, 3600000);
        }

        async function init() {
            try {
                await registerOrLogin();
                document.getElementById('userName').innerText = userName;
                document.getElementById('tokensText').innerText = formatNumber(tokens);
                document.getElementById('tokensPerMinuteText').innerText = formatNumber(tokensPerHour);
                document.getElementById('levelText').innerText = `Nível ${level}`;
                updateLevelBar();
                generateTokensGradually();

                document.getElementById('greenSquare').addEventListener('click', () => {
                    document.getElementById('modal').style.display = 'flex';
                });

                document.getElementById('closeModal').addEventListener('click', () => {
                    document.getElementById('modal').style.display = 'none';
                });

                document.getElementById('buyTokenPerMinute1').addEventListener('click', (event) => buyOrUpgradeTokensPerHour(event.currentTarget));
                document.getElementById('buyTokenPerMinute2').addEventListener('click', (event) => buyOrUpgradeTokensPerHour(event.currentTarget));
                document.getElementById('buyTokenPerMinute3').addEventListener('click', (event) => buyOrUpgradeTokensPerHour(event.currentTarget));
                document.getElementById('buyTokenPerMinute4').addEventListener('click', (event) => buyOrUpgradeTokensPerHour(event.currentTarget));

                document.getElementById('closeConfirmPurchaseModal').addEventListener('click', () => {
                    document.getElementById('confirmPurchaseModal').style.display = 'none';
                    purchaseConfirmationPending = false;
                });

                document.getElementById('confirmPurchaseButton').addEventListener('click', confirmPurchase);
            } catch (error) {
                console.error('Erro ao inicializar o jogo:', error);
            }
        }

        init();
    </script>
</body>

</html>
